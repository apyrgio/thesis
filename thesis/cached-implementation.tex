\chapter{Implementation of cached}\label{ch:cached-implementation}

In the previous chapter, we presented a design overview for cached and its 
components. In this chapter we will blabla how the above design has been
implemented and explain in depth the structures and functions that have been 
created for this purpose.

More specifically, sections ? - ? provide implementation information for the 
components of cached, as described in Chapter ?. Next, section ? presents the 
actual initialization and blabla operations using excerpts from the code.

\section{Implementation of xcache}

In this section we describe how we implemented the design concept of 
Section\ref{sec:xcache-design}.

This is the main xcache struct:

\ccode{Main xcache struct}{xcache-struct.h}

and this is a reference to it: \ref{lst:xcache-struct.h}

%Enter C code here

\subsection{Concurrency control}

\paragraph{Reference counting}

The refcount model in xcache should be familiar to most people:

% Turn this to figure
\begin{itemize}
	\item When an entry is inserted in cache, the cache holds a reference 
		for it (ref = 1).
	\item Whenever a new lookup for this cache entry succeeds, the reference 
		is increased by 1 (ref++)
	\item When the request that has issued the lookup has finished with an 
		entry, the reference is decreased by 1. (ref--)
	\item When a cache entry is evicted by cache, the its ref is decreased 
		by 1. (ref--)
\end{itemize}

Some common refcount cases are:

\begin{itemize}
	\item active entry with pending jobs (ref > 1)
	\item active entry with no pending jobs (ref = 1)
	\item evicted entry with pending jobs (ref > 0)
	\item evicted entry with no pending jobs (ref = 0)
\end{itemize}

\begin{table}[tbp]
	\centering
	\begin{tabular}{ | l | l | }
		\hline
		Case & Refcount \\ \hline \hline
		active entry with pending jobs & ref > 1 \\ \hline
		active entry with no pending jobs & ref = 1 \\ \hline
		evicted entry with pending jobs & ref > 0 \\ \hline
		evicted entry with no pending jobs & ref = 0 \\ \hline
	\end{tabular}
	\caption{Reference counting of xcache}
	\label{tab:refcount}
\end{table}

and, as always, the entry is freed only when its ref = 0.

